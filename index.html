<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Carango TV — Browse & Search</title>
<style>
  :root{ --bg:#181818; --panel:#141414; --fg:#fff; --muted:#bdbdbd; --accent:#e50914; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,Segoe UI,Roboto,Arial,sans-serif}

  header{display:grid;grid-template-columns:auto minmax(300px,1fr) auto;align-items:center;gap:14px;position:sticky;top:0;z-index:3000;background:var(--panel);padding:10px 16px}
  .brand h2{margin:0}
  .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
  .chip,select,.btn{background:#2a2a2a;color:#fff;border:0;border-radius:999px;padding:10px 14px;cursor:pointer;font-weight:600}
  .chip.active{background:var(--accent)}
  .btn.primary{background:var(--accent)}

  .search-wrap{position:relative;display:flex;align-items:center}
  #searchBox{width:100%;max-width:560px;background:#2a2a2a;color:#fff;border:1px solid #333;border-radius:999px;padding:10px 14px}
  #searchBox::placeholder{color:#9a9a9a}
  .sugg{position:absolute;left:0;top:calc(100% + 6px);width:100%;max-width:560px;background:#0f0f0f;border:1px solid #222;border-radius:12px;overflow-y:auto;max-height:700px;box-shadow:0 12px 30px rgba(0,0,0,.45);display:none;z-index:9999}
  .sugg-item{display:flex;gap:10px;align-items:center;padding:8px 10px;cursor:pointer;border-bottom:1px solid #1f1f1f}
  .sugg-item:last-child{border-bottom:0}
  .sugg-item img{width:40px;height:60px;object-fit:cover;border-radius:6px}
  .sugg-item .name{font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:380px}
  .sugg-item .meta{font-size:12px;color:#bdbdbd}

  main{padding:22px}
  h2{margin:0 0 12px 4px;font-size:22px}
  .status{margin:10px 6px;color:var(--muted)}

  .filters{display:flex;gap:10px;align-items:center;flex-wrap:wrap;background:#111;border:1px solid #222;border-radius:12px;padding:10px 12px;margin:10px 4px 16px}
  .filters label{font-size:13px;color:#cfcfcf;margin-right:6px}

  .row.vertical{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:16px;padding:6px 4px 12px}
  .card{background:#0f0f0f;border-radius:10px;overflow:hidden;cursor:pointer;transition:transform .2s ease,box-shadow .2s ease;border:1px solid #222}
  .card:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .card img{width:100%;aspect-ratio:2/3;object-fit:cover}

  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.6);z-index:30}
  .modal.open{display:grid}
  .sheet{max-width:880px;width:min(92vw,880px);background:#111;border:1px solid #222;border-radius:16px;overflow:hidden}
  .sheet-wrap{display:grid;grid-template-columns:280px 1fr;gap:16px;padding:16px}
  .sheet img{width:100%;border-radius:10px}
  .sheet-actions{display:flex;gap:10px;margin-top:12px}
  .season-episode{display:none;gap:.75rem;align-items:center;flex-wrap:wrap;margin-top:10px}
  .season-episode select{background:#141414;color:#fff;border:1px solid #333;border-radius:8px;padding:.5rem .6rem}

  .trailer{margin-top:10px;border:1px solid #222;border-radius:10px;overflow:hidden;background:#000;position:relative;aspect-ratio:16/9;display:none}
  .trailer img{width:100%;height:100%;object-fit:cover;display:block}
  .trailer button.play{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(to bottom,rgba(0,0,0,.05),rgba(0,0,0,.45));border:0;cursor:pointer}
  .trailer button.play::before{content:"▶";font-size:48px;color:#fff;text-shadow:0 2px 10px rgba(0,0,0,.6)}

  .player-overlay{position:fixed;inset:0;background:#000;display:none;z-index:9999}
  .player-overlay.open{display:grid;grid-template-rows:auto 1fr}
  .player-bar{display:flex;gap:10px;align-items:center;padding:10px 12px;background:#0f0f0f;border-bottom:1px solid #222;color:#fff}
  .player-frame{width:100%;height:100%;border:0}
</style>
</head>
<body>

<header>
  <div class="brand"><h2 style="color:#FF0000;padding-top:10px;">Carango Tv</h2></div>
  <div class="search-wrap">
    <input id="searchBox" type="text" placeholder="Search movies & TV shows… (e.g. Dune, The Bear)" autocomplete="off"/>
    <div id="suggList" class="sugg"></div>
  </div>
  <div class="controls">
    <button class="chip active" id="tabMovie" onclick="switchType('movie')">Movies</button>
    <button class="chip" id="tabTV" onclick="switchType('tv')">TV Shows</button>
    <select id="timeSelect" onchange="reloadTrending()">
      <option value="day">Today</option><option value="week">This Week</option>
    </select>
  </div>
</header>

<main>
  <h2 id="sectionTitle">Trending Movies</h2>
  <div class="filters">
    <div class="group">
      <label for="genreSelect">Genre</label>
      <select id="genreSelect"><option value="">All Genres</option></select>
    </div>
    <div class="group">
      <label for="sortSelect">Sort</label>
      <select id="sortSelect">
        <option value="date_desc">Newest → Oldest</option>
        <option value="date_asc">Oldest → Newest</option>
        <option value="rating_desc">Top Rated</option>
      </select>
    </div>
    <button class="btn primary" onclick="applyFilters()">Apply</button>
  </div>
  <div class="status" id="status"></div>
  <div id="contentRow" class="row vertical"></div>
</main>

<!-- Detail Modal -->
<div class="modal" id="modal">
  <div class="sheet">
    <div class="sheet-wrap">
      <img id="mPoster" alt="Poster">
      <div>
        <h3 id="mTitle"></h3>
        <div id="mMeta"></div>
        <div id="trailerWrap" class="trailer"></div>
        <p id="mOverview"></p>
        <div class="season-episode" id="tvControls">
          <label>Season</label><select id="seasonSelect" disabled><option>Loading…</option></select>
          <label>Episode</label><select id="episodeSelect" disabled><option>Select season</option></select>
        </div>
        <div class="sheet-actions">
          <button class="btn primary" id="playBtn">▶ Play</button>
          <button class="btn" onclick="closeModal()">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Player Overlay -->
<div id="playerOverlay" class="player-overlay">
  <div class="player-bar">
    <strong id="playerTitle">Playing</strong>
    <span class="spacer"></span>
    <button id="prevEpBtn">⟨ Prev</button>
    <button id="nextEpBtn">Next ⟩</button>
    <button id="closePlayerBtn" class="btn">Exit</button>
  </div>
  <iframe id="playerFrame" class="player-frame" allow="autoplay; encrypted-media; picture-in-picture; fullscreen" allowfullscreen></iframe>
</div>

<script>
/*** CONFIG & STATE ***/
const TMDB_API_KEY="915f1289f9c31479b780789c30ae6b2b";
const IMG="https://image.tmdb.org/t/p/w300"; const IMG92="https://image.tmdb.org/t/p/w92";
let currentPage=1,totalPages=1,isLoadingMore=false,currentType="movie";
let cached=[],lastFetchMode="trending"; const seenIds=new Set();

/*** BOOT ***/
document.addEventListener("DOMContentLoaded",()=>{
  wireSearch(); loadGenres(); reloadTrending();

  // Pure infinite scroll + auto-top-up for huge screens
  const THRESHOLD=1200; // px from bottom to trigger
  window.addEventListener('scroll',onScroll,{passive:true});
  window.addEventListener('resize',()=>ensureScrollable(),{passive:true});
  requestAnimationFrame(()=>{window.dispatchEvent(new Event('scroll')); ensureScrollable();});

  async function onScroll(){
    const doc=document.documentElement;
    if(isLoadingMore||currentPage>=totalPages) return;
    if(doc.clientHeight + window.scrollY < doc.scrollHeight - THRESHOLD) return;

    isLoadingMore=true; currentPage+=1;
    try{
      if(lastFetchMode==='discover') await discoverFetch(currentPage,true);
      else await loadTrending(currentType,document.getElementById('timeSelect').value,true);
    } finally { isLoadingMore=false; }
  }
});

/*** Ensures the page is tall enough to scroll (4K TVs, etc.) ***/
async function ensureScrollable(){
  const doc=document.documentElement; const NEED=300;
  while(currentPage<totalPages && (doc.scrollHeight - doc.clientHeight) < NEED){
    if(isLoadingMore) break;
    isLoadingMore=true; currentPage+=1;
    try{
      if(lastFetchMode==='discover') await discoverFetch(currentPage,true);
      else await loadTrending(currentType,document.getElementById('timeSelect').value,true);
    } finally { isLoadingMore=false; }
  }
}

/*** TYPE / GENRES ***/
function switchType(t){
  currentType=t;
  document.getElementById('tabMovie').classList.toggle('active',t==='movie');
  document.getElementById('tabTV').classList.toggle('active',t==='tv');
  if(lastFetchMode==="trending") reloadTrending(); else applyFilters();
  loadGenres();
}

async function loadGenres(){
  const sel=document.getElementById("genreSelect");
  sel.innerHTML=`<option value="">All Genres</option>`;
  try{
    const r=await fetch(`https://api.themoviedb.org/3/genre/${currentType}/list?api_key=${TMDB_API_KEY}`);
    const d=await r.json();
    (d.genres||[]).forEach(g=>{const o=document.createElement('option');o.value=g.id;o.textContent=g.name;sel.appendChild(o);});
  }catch{}
}

/*** UTIL ***/
function setStatus(t){document.getElementById('status').textContent=t||"";}
function isReleased(i,t){const d=t==='tv'?(i.first_air_date||''):(i.release_date||'');return d && d<=new Date().toISOString().slice(0,10);}

/*** TRENDING & DISCOVER ***/
function reloadTrending(){lastFetchMode="trending";loadTrending(currentType,document.getElementById('timeSelect').value);}
async function loadTrending(type="movie",time="day",append=false){
  if(!append){setStatus("Loading…");currentPage=1;}
  try{
    const url=`https://api.themoviedb.org/3/trending/${type}/${time}?api_key=${TMDB_API_KEY}&page=${currentPage}`;
    const res=await fetch(url); if(!res.ok) throw new Error(res.status);
    const data=await res.json(); totalPages=data.total_pages||1;
    const items=(data.results||[]).filter(r=>isReleased(r,type));
    if(append) appendRow(items,type);
    else {cached=items; renderRow(cached,type); setStatus(""); await ensureScrollable();}
  }catch(e){console.error(e); if(!append) setStatus("Error fetching data");}
  finally{isLoadingMore=false;}
}

function applyFilters(){lastFetchMode="discover";currentPage=1;discoverFetch();}
async function discoverFetch(page=1,append=false){
  const g=document.getElementById('genreSelect').value||"", s=document.getElementById('sortSelect').value;
  let sort="vote_average.desc";
  if(s==="date_desc") sort=currentType==='movie'?"primary_release_date.desc":"first_air_date.desc";
  if(s==="date_asc")  sort=currentType==='movie'?"primary_release_date.asc":"first_air_date.asc";
  const today=new Date().toISOString().slice(0,10);
  const guard=currentType==='movie'?`&primary_release_date.lte=${today}`:`&first_air_date.lte=${today}`;
  if(!append) setStatus("Loading…");
  try{
    const url=`https://api.themoviedb.org/3/discover/${currentType}?api_key=${TMDB_API_KEY}&page=${page}&include_adult=false&sort_by=${encodeURIComponent(sort)}${g?`&with_genres=${g}`:""}${guard}`;
    const r=await fetch(url); if(!r.ok) throw new Error(r.status);
    const d=await r.json(); totalPages=d.total_pages||1;
    const items=(d.results||[]).filter(r=>isReleased(r,currentType));
    if(append) appendRow(items,currentType);
    else {cached=items; renderRow(cached,currentType); setStatus(""); await ensureScrollable();}
  }catch(e){console.error(e); if(!append) setStatus("Error loading results");}
  finally{isLoadingMore=false;}
}

/*** RENDER ***/
function renderRow(items,type){const row=document.getElementById("contentRow");row.innerHTML="";seenIds.clear();appendRow(items,type);}
function appendRow(items,type){
  const row=document.getElementById("contentRow");
  items.forEach(m=>{
    if(seenIds.has(m.id)) return; seenIds.add(m.id);
    const title=m.title||m.name||"Untitled"; const rating=(m.vote_average||0).toFixed(1);
    const poster=m.poster_path?IMG+m.poster_path:"https://via.placeholder.com/300x450?text=No+Image";
    const card=document.createElement("div"); card.className="card";
    card.innerHTML=`<img src="${poster}" alt="${title}"><div class="meta"><div>${title}</div><div>⭐ ${rating}</div></div>`;
    card.onclick=()=>openModal(m,type);
    row.appendChild(card);
  });
}

/*** MODAL (simplified) ***/
const tvControls=document.getElementById('tvControls'), seasonSelect=document.getElementById('seasonSelect'), episodeSelect=document.getElementById('episodeSelect');
function openModal(item,type){
  const modalType=type||item.media_type||'movie';
  document.getElementById("modal").classList.add("open");
  document.getElementById("mPoster").src=item.poster_path?IMG+item.poster_path:"https://via.placeholder.com/300x450?text=No+Image";
  document.getElementById("mTitle").textContent=item.title||item.name;
  document.getElementById("mMeta").textContent=`${modalType.toUpperCase()} • ${item.release_date||item.first_air_date||"Unknown"} • ⭐ ${(item.vote_average||0).toFixed(1)}`;
  document.getElementById("mOverview").textContent=item.overview||"No description available.";

  const playBtn=document.getElementById("playBtn");
  if(modalType==="tv"){
    tvControls.style.display='flex';
    loadSeasons(item.id);
    playBtn.onclick=()=>{ closeModal(); window.location.href=`https://vidsrc.xyz/embed/tv/${item.id}?season=1&episode=1`; };
  }else{
    tvControls.style.display='none';
    playBtn.onclick=()=>{ window.location.href=`https://vidsrc.xyz/embed/movie/${item.id}`; };
  }
}
function closeModal(){document.getElementById("modal").classList.remove("open");}

async function loadSeasons(tvId){
  seasonSelect.disabled=true;episodeSelect.disabled=true;
  const meta=await fetch(`https://api.themoviedb.org/3/tv/${tvId}?api_key=${TMDB_API_KEY}`).then(r=>r.json());
  const s=(meta.seasons||[]).filter(x=>x.season_number>0);
  seasonSelect.innerHTML=s.map(x=>`<option value='${x.season_number}'>S${x.season_number}</option>`).join('');
  seasonSelect.disabled=false;episodeSelect.disabled=false;
}

/*** SEARCH ***/
function wireSearch(){
  const box=document.getElementById("searchBox"), list=document.getElementById("suggList");
  box.addEventListener("input", async ()=>{
    const q=box.value.trim(); if(!q){list.style.display="none"; return;}
    try{
      let results=[];
      for(let p=1;p<=3;p++){
        const url=`https://api.themoviedb.org/3/search/multi?api_key=${TMDB_API_KEY}&language=en-US&query=${encodeURIComponent(q)}&page=${p}&include_adult=false`;
        const res=await fetch(url); if(!res.ok) break;
        const data=await res.json(); if(!data.results?.length) break;
        results=results.concat(data.results); if(p>=(data.total_pages||1)) break;
      }
      list.innerHTML="";
      results.forEach(item=>{
        const title=item.title||item.name; if(!title) return;
        const poster=item.poster_path?IMG92+item.poster_path:"https://via.placeholder.com/92x138?text=No+Image";
        const el=document.createElement("div"); el.className="sugg-item";
        el.innerHTML=`<img src="${poster}" alt=""><div class="t"><div class="name">${title}</div><div class="meta">${(item.media_type||'').toUpperCase()} • ${(item.release_date||item.first_air_date||'')}</div></div>`;
        el.onclick=()=>{ openModal(item,item.media_type); list.style.display="none"; };
        list.appendChild(el);
      });
      list.style.display=results.length?"block":"none";
    }catch(e){ console.error(e); list.style.display="none"; }
  });
  document.addEventListener("click",(e)=>{ if(!list.contains(e.target)&&e.target!==box){ list.style.display="none"; }});
}
</script>
</body>
</html>
